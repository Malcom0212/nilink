---
phase: 05-deploiement-cloud-railway
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - railway.toml
autonomous: true

must_haves:
  truths:
    - "Dockerfile CMD utilise la forme shell pour expansion de $PORT"
    - "railway.toml configure le healthcheck sur /health avec timeout 300s et restart on failure"
    - "Le build Docker fonctionne toujours localement apres les modifications"
  artifacts:
    - path: "Dockerfile"
      provides: "Container image compatible Railway avec $PORT dynamique"
      contains: "CMD uvicorn api:app --host 0.0.0.0 --port $PORT"
    - path: "railway.toml"
      provides: "Configuration Railway as Code (healthcheck, restart policy, builder)"
      contains: "healthcheckPath"
  key_links:
    - from: "Dockerfile"
      to: "Railway $PORT injection"
      via: "Shell form CMD expanse $PORT au runtime"
      pattern: "CMD uvicorn.*\\$PORT"
    - from: "railway.toml"
      to: "/health endpoint dans api.py"
      via: "healthcheckPath pointe vers endpoint existant"
      pattern: 'healthcheckPath = "/health"'
---

<objective>
Preparer le codebase Nilink pour un deploiement Railway sans friction.

Purpose: Le Dockerfile actuel utilise CMD en forme exec qui n'expanse pas la variable $PORT injectee par Railway, causant "Application Failed to Respond". Il faut passer en forme shell et ajouter un railway.toml pour le healthcheck et la restart policy.

Output: Dockerfile modifie + railway.toml cree, prets pour Railway.
</objective>

<execution_context>
@C:\Users\matys\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\matys\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/05-deploiement-cloud-railway/05-RESEARCH.md
@Dockerfile
@config.py
@api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modifier Dockerfile CMD pour forme shell + creer railway.toml</name>
  <files>Dockerfile, railway.toml</files>
  <action>
1. **Modifier `Dockerfile`** â€” Changer UNIQUEMENT la derniere ligne CMD:
   - AVANT: `CMD ["uvicorn", "api:app", "--host", "0.0.0.0", "--port", "8000"]`
   - APRES: `CMD uvicorn api:app --host 0.0.0.0 --port $PORT`
   - NE PAS modifier le reste du Dockerfile (apt-get, WORKDIR, COPY, pip install sont deja corrects)
   - Garder `EXPOSE 8000` (documentaire seulement, Railway ignore)

2. **Creer `railway.toml`** a la racine du projet avec ce contenu exact:
   ```toml
   [build]
   builder = "DOCKERFILE"
   dockerfilePath = "Dockerfile"

   [deploy]
   healthcheckPath = "/health"
   healthcheckTimeout = 300
   restartPolicyType = "ON_FAILURE"
   restartPolicyMaxRetries = 3
   ```

   Pourquoi ces valeurs:
   - `builder = "DOCKERFILE"`: Force Railway a utiliser notre Dockerfile (pas Nixpacks/Railpack)
   - `healthcheckPath = "/health"`: Pointe vers l'endpoint existant dans api.py qui retourne 200 + status engine
   - `healthcheckTimeout = 300`: 300 secondes pour laisser le temps a OpenCV de s'initialiser au premier deploy
   - `restartPolicyType = "ON_FAILURE"` + `maxRetries = 3`: Redemarrage automatique en cas de crash, max 3 tentatives
  </action>
  <verify>
1. Verifier que le Dockerfile contient `CMD uvicorn api:app --host 0.0.0.0 --port $PORT` (forme shell, PAS de crochets JSON)
2. Verifier que `railway.toml` existe et contient `healthcheckPath = "/health"`
3. Build Docker local reussit: `docker build -t nilink-test .` (si Docker disponible)
  </verify>
  <done>
- Dockerfile utilise forme shell CMD avec $PORT variable
- railway.toml configure builder DOCKERFILE, healthcheck /health (300s timeout), restart ON_FAILURE (3 retries)
- Aucun autre fichier modifie (config.py, api.py inchanges)
  </done>
</task>

</tasks>

<verification>
1. `grep "CMD uvicorn" Dockerfile` retourne la forme shell (sans crochets)
2. `cat railway.toml` montre healthcheckPath, restartPolicyType, builder
3. Optionnel: `docker build -t nilink-test .` reussit sans erreur
</verification>

<success_criteria>
- Dockerfile pret pour Railway (CMD shell form avec $PORT)
- railway.toml cree avec configuration deploiement
- Build Docker local fonctionne toujours
</success_criteria>

<output>
After completion, create `.planning/phases/05-deploiement-cloud-railway/05-01-SUMMARY.md`
</output>
