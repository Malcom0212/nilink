---
phase: 05-deploiement-cloud-railway
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: []
autonomous: false
user_setup:
  - service: railway
    why: "Plateforme de deploiement cloud PaaS"
    env_vars:
      - name: LOG_LEVEL
        source: "Valeur: info (defaut)"
      - name: RATE_LIMIT
        source: "Valeur: 60/minute (defaut)"
      - name: RATE_LIMIT_BATCH
        source: "Valeur: 10/minute (defaut)"
      - name: CORS_ORIGINS
        source: "Valeur: * ou domaines specifiques (ex: https://yourdomain.com)"
    dashboard_config:
      - task: "Creer un compte Railway"
        location: "https://railway.com — Sign up with GitHub"
      - task: "Creer un projet depuis GitHub repo"
        location: "Railway Dashboard > New Project > Deploy from GitHub repo > selectionner nilink"
      - task: "Configurer variables d'environnement (optionnel)"
        location: "Railway Dashboard > Service > Settings > Variables"

must_haves:
  truths:
    - "L'API Nilink est accessible via HTTPS sur une URL Railway publique"
    - "L'endpoint /health retourne 200 avec status ok"
    - "L'endpoint /verify accepte des images et retourne un score de confiance"
    - "La documentation Swagger est accessible sur /docs"
    - "Les deploiements automatiques se declenchent sur git push"
  artifacts: []
  key_links:
    - from: "Railway service"
      to: "/health endpoint"
      via: "HTTPS public domain"
      pattern: "https://.*\\.up\\.railway\\.app/health"
    - from: "GitHub repo"
      to: "Railway auto-deploy"
      via: "GitHub integration"
      pattern: "push to main triggers deploy"
---

<objective>
Deployer Nilink sur Railway et verifier que l'API fonctionne en production.

Purpose: Mettre l'API en ligne avec HTTPS, CI/CD automatique, et monitoring pour que les utilisateurs puissent acceder au service de verification forensique.

Output: API Nilink deployee et fonctionnelle sur Railway avec URL publique HTTPS.
</objective>

<execution_context>
@C:\Users\matys\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\matys\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/05-deploiement-cloud-railway/05-RESEARCH.md
@.planning/phases/05-deploiement-cloud-railway/05-01-SUMMARY.md
@Dockerfile
@railway.toml
@api.py
@config.py
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Creer le projet Railway et deployer depuis GitHub</name>
  <action>
L'utilisateur doit effectuer ces etapes dans le navigateur:

1. **Creer un compte Railway** (si pas deja fait):
   - Aller sur https://railway.com
   - S'inscrire avec GitHub (recommande pour integration CI/CD)
   - Plan Hobby: $5/mois (inclut $5 de credits)

2. **S'assurer que le code est pousse sur GitHub**:
   - Le repo `nilink` doit etre sur GitHub avec les derniers commits (Dockerfile modifie + railway.toml)
   - Si pas encore sur GitHub: creer le repo et pousser

3. **Creer le projet Railway**:
   - Railway Dashboard > "New Project"
   - Selectionner "Deploy from GitHub repo"
   - Autoriser l'acces Railway a votre GitHub si demande
   - Selectionner le repo `nilink`
   - Railway detecte automatiquement le Dockerfile et commence le build

4. **Generer un domaine public**:
   - Une fois le service cree: Service > Settings > Networking
   - Cliquer "Generate Domain" pour obtenir une URL `*.up.railway.app`
   - HTTPS est provisionne automatiquement (Let's Encrypt)

5. **Configurer les variables d'environnement** (optionnel):
   - Service > Settings > Variables
   - Railway injecte automatiquement `PORT` — NE PAS le setter manuellement
   - Optionnel: ajouter `LOG_LEVEL=info`, `CORS_ORIGINS=*` si besoin d'overrider les defauts

6. **Attendre le deploiement**:
   - Le build prend ~2-5 minutes (installation OpenCV + dependencies)
   - Le healthcheck sur /health doit passer (timeout 300s)
   - Le service passe en status "Active" quand pret
  </action>
  <resume-signal>Fournir l'URL Railway publique (ex: https://nilink-production.up.railway.app) ou decrire les problemes rencontres</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>API Nilink deployee sur Railway avec HTTPS, healthcheck, et CI/CD automatique</what-built>
  <how-to-verify>
Tester les endpoints suivants avec l'URL Railway fournie (remplacer $URL par l'URL reelle):

1. **Health check:**
   ```
   curl https://$URL/health
   ```
   Attendu: `{"status":"ok","engine_version":"0.1.0","detectors":{"ela":true,"fft":true,"rppg":true,"upscale":true}}`

2. **Documentation Swagger:**
   Ouvrir `https://$URL/docs` dans le navigateur
   Attendu: Interface Swagger UI avec tous les endpoints documentes

3. **Test verification image:**
   ```
   curl -X POST https://$URL/verify -F "file=@test_image.jpg"
   ```
   Attendu: JSON avec `global_trust_score`, `anomalies_found`, `processing_time_ms`

4. **Verifier CI/CD:**
   - Faire un petit commit (ex: ajouter un commentaire dans api.py)
   - Pousser sur GitHub
   - Verifier dans Railway Dashboard que le re-deploy se declenche automatiquement

5. **Verifier monitoring:**
   - Railway Dashboard > Service > Logs: les logs JSON structurees apparaissent
   - Railway Dashboard > Service > Metrics: CPU et RAM sont visibles
  </how-to-verify>
  <resume-signal>Confirmer "approved" si tout fonctionne, ou decrire les problemes rencontres</resume-signal>
</task>

</tasks>

<verification>
1. `curl https://$RAILWAY_URL/health` retourne 200 avec status "ok"
2. `curl -X POST https://$RAILWAY_URL/verify -F "file=@image.jpg"` retourne un score de confiance
3. `https://$RAILWAY_URL/docs` affiche la documentation Swagger
4. Un git push declenche un re-deploiement automatique dans Railway
5. Les logs et metriques sont visibles dans Railway Dashboard
</verification>

<success_criteria>
- API accessible via HTTPS sur URL Railway publique
- /health retourne 200 + status ok
- /verify fonctionne avec des images uploadees
- /docs affiche la documentation Swagger
- CI/CD: git push declenche auto-deploy
- Logs et metriques visibles dans Railway Dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/05-deploiement-cloud-railway/05-02-SUMMARY.md`
</output>
